<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Mali', cursive; }</style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

    <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-xl p-8 relative">
        
        <button onclick="logoutAndGoBack()" class="absolute top-8 right-8 bg-gray-100 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-200 transition text-sm font-bold flex items-center gap-2 cursor-pointer">
            üì± ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö & ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏û ‚û°Ô∏è
        </button>

        <h1 class="text-3xl font-bold text-purple-700 mb-6 flex items-center gap-3">
            üõ†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </h1>

        <div class="bg-yellow-50 p-4 rounded-xl border-2 border-yellow-200 mb-8 text-sm">
            <h3 class="font-bold text-yellow-800 mb-2">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Service Role Key)</h3>
            <div class="grid gap-2 mt-3">
                <input type="text" id="supabase-url" placeholder="Supabase URL" class="w-full p-2 border rounded">
                <input type="password" id="service-key" placeholder="Service Role Key (secret)" class="w-full p-2 border rounded">
                <button onclick="connectAdmin()" class="bg-purple-600 text-white py-2 rounded hover:bg-purple-700">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>

        <div id="admin-panel" class="hidden space-y-8">
            
            <div class="bg-blue-50 p-6 rounded-2xl border-2 border-blue-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-blue-800 mb-2">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á Students</h2>
                        <p class="text-blue-600 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ <b>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</b> ‡∏à‡∏≤‡∏Å‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∞‡πÉ‡∏ä‡πâ 123456)</p>
                    </div>
                    <button onclick="syncFromTable()" id="btn-sync" class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 font-bold shadow-lg flex items-center gap-2">
                        üöÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á User ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    </button>
                </div>
                <div id="sync-log" class="mt-4 text-sm text-gray-600 max-h-40 overflow-y-auto bg-white p-2 rounded border hidden"></div>
            </div>

            <div class="bg-green-50 p-6 rounded-2xl border-2 border-green-200">
                <h2 class="text-xl font-bold text-green-800 mb-4">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô (Manual)</h2>
                <div class="flex flex-wrap gap-4 items-end">
                    <input type="text" id="new-id" class="p-2 border rounded w-28" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                    <input type="text" id="new-name" class="p-2 border rounded w-40" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•">
                    <input type="text" id="new-pass" class="p-2 border rounded w-32" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                    
                    <select id="new-grade" class="p-2 border rounded w-24 bg-white">
                        <option value="P.1">‡∏õ.1</option> <option value="P.2">‡∏õ.2</option> <option value="P.3">‡∏õ.3</option>
                        <option value="P.4">‡∏õ.4</option> <option value="P.5">‡∏õ.5</option> <option value="P.6">‡∏õ.6</option>
                        <option value="M.1">‡∏°.1</option> <option value="M.2">‡∏°.2</option> <option value="M.3">‡∏°.3</option>
                    </select>
                    <button onclick="createSingleUser()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Auth Users)</h2>
                    <button onclick="fetchUsers()" class="text-purple-600">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                </div>
                <div class="overflow-x-auto bg-white border rounded-xl shadow-sm">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-purple-50 text-purple-800">
                            <tr>
                                <th class="p-4 border-b">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                <th class="p-4 border-b">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="p-4 border-b">‡∏ä‡∏±‡πâ‡∏ô (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</th>
                                <th class="p-4 border-b w-1/3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ / ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ä‡∏±‡πâ‡∏ô</th>
                            </tr>
                        </thead>
                        <tbody id="user-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DOMAIN_SUFFIX = '@school.local';
        let supabaseAdmin = null;

        window.onload = () => {
            if(localStorage.getItem('sb_url')) document.getElementById('supabase-url').value = localStorage.getItem('sb_url');
            if(localStorage.getItem('sb_key')) document.getElementById('service-key').value = localStorage.getItem('sb_key');
        }

        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Logout ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
        function logoutAndGoBack() {
            // ‡∏•‡∏π‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ LocalStorage ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const keysToKeep = ['sb_url', 'sb_key']; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Admin ‡πÑ‡∏ß‡πâ (Url, Key)
            
            // ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö Session ‡∏Ç‡∏≠‡∏á Supabase ‡∏≠‡∏≠‡∏Å
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                // ‡∏ñ‡πâ‡∏≤ Key ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà URL ‡∏´‡∏£‡∏∑‡∏≠ Service Key ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á Session login)
                if (!keysToKeep.includes(key)) {
                    localStorage.removeItem(key);
                }
            }
            
            // ‡∏î‡∏µ‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ index
            window.location.href = 'index.html';
        }

        function connectAdmin() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('service-key').value.trim();
            if (!url || !key) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
            localStorage.setItem('sb_url', url); localStorage.setItem('sb_key', key);

            try {
                supabaseAdmin = supabase.createClient(url, key, { auth: { autoRefreshToken: false, persistSession: false } });
                document.getElementById('admin-panel').classList.remove('hidden');
                fetchUsers();
                alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ');
            } catch (e) { alert('Error: ' + e.message); }
        }

        async function syncFromTable() {
            const btn = document.getElementById('btn-sync');
            const logDiv = document.getElementById('sync-log');
            
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á User ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á students ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;

            btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...';
            btn.disabled = true;
            logDiv.classList.remove('hidden');
            logDiv.innerHTML = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...<br>';

            try {
                const { data: students, error: dbError } = await supabaseAdmin.from('students').select('*');
                if (dbError) throw dbError;

                if (!students || students.length === 0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á students');

                const { data: { users }, error: authError } = await supabaseAdmin.auth.admin.listUsers();
                if (authError) throw authError;
                
                const existingEmails = new Set(users.map(u => u.email));
                let createdCount = 0;

                for (const student of students) {
                    const email = student.student_id.trim() + DOMAIN_SUFFIX;
                    const userPass = student.password && student.password.toString().trim() !== '' ? student.password.toString() : '123456';

                    if (existingEmails.has(email)) {
                        logDiv.innerHTML += `<span class="text-gray-400">‡∏Ç‡πâ‡∏≤‡∏°: ${student.student_id} (‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß)</span><br>`;
                        continue;
                    }

                    const { error: createError } = await supabaseAdmin.auth.admin.createUser({
                        email: email,
                        password: userPass,
                        email_confirm: true,
                        user_metadata: { grade: student.grade, name: student.full_name }
                    });

                    if (createError) {
                        logDiv.innerHTML += `<span class="text-red-500">Error ${student.student_id}: ${createError.message}</span><br>`;
                    } else {
                        logDiv.innerHTML += `<span class="text-green-600">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${student.student_id}</span><br>`;
                        createdCount++;
                    }
                }
                alert(`‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏™‡∏£‡πâ‡∏≤‡∏á User ‡πÉ‡∏´‡∏°‡πà ${createdCount} ‡∏Ñ‡∏ô`);
                fetchUsers();
            } catch (err) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message); } 
            finally { btn.textContent = 'üöÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á User ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á'; btn.disabled = false; }
        }

        async function fetchUsers() {
            const tbody = document.getElementById('user-list');
            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>';
            
            const { data: { users }, error } = await supabaseAdmin.auth.admin.listUsers();
            if (error) return alert(error.message);

            const students = users.filter(u => u.email && u.email.endsWith(DOMAIN_SUFFIX));
            students.sort((a, b) => a.email.localeCompare(b.email));

            tbody.innerHTML = '';
            students.forEach(u => {
                const id = u.email.split('@')[0];
                const meta = u.user_metadata || {};
                const name = meta.name || '-';
                const grade = meta.grade || 'P.1';

                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-4 font-bold text-gray-700">${id}</td>
                        <td class="p-4 text-gray-600">${name}</td>
                        <td class="p-4"><span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-bold">${grade}</span></td>
                        <td class="p-4 flex items-center gap-2">
                            <select id="grade-${u.id}" class="border-2 border-purple-200 rounded p-1 text-sm bg-white">
                                <option value="P.1" ${grade==='P.1'?'selected':''}>‡∏õ.1</option>
                                <option value="P.2" ${grade==='P.2'?'selected':''}>‡∏õ.2</option>
                                <option value="P.3" ${grade==='P.3'?'selected':''}>‡∏õ.3</option>
                                <option value="P.4" ${grade==='P.4'?'selected':''}>‡∏õ.4</option>
                                <option value="P.5" ${grade==='P.5'?'selected':''}>‡∏õ.5</option>
                                <option value="P.6" ${grade==='P.6'?'selected':''}>‡∏õ.6</option>
                                <option value="M.1" ${grade==='M.1'?'selected':''}>‡∏°.1</option>
                                <option value="M.2" ${grade==='M.2'?'selected':''}>‡∏°.2</option>
                                <option value="M.3" ${grade==='M.3'?'selected':''}>‡∏°.3</option>
                            </select>
                            <button onclick="updateGrade('${u.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                            <button onclick="deleteUser('${u.id}')" class="bg-red-100 text-red-500 px-3 py-1 rounded text-sm hover:bg-red-200">‡∏•‡∏ö</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function updateGrade(uid) {
            const newGrade = document.getElementById(`grade-${uid}`).value;
            const btn = event.target;
            btn.textContent = '...';
            
            const { error } = await supabaseAdmin.auth.admin.updateUserById(
                uid,
                { user_metadata: { grade: newGrade } }
            );

            if (error) {
                alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message);
                btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            } else {
                const row = btn.closest('tr');
                const badge = row.querySelector('span');
                badge.textContent = newGrade;
                btn.textContent = '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
                setTimeout(() => btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 1500);
            }
        }

        async function createSingleUser() {
            const id = document.getElementById('new-id').value.trim();
            const name = document.getElementById('new-name').value.trim();
            const passInput = document.getElementById('new-pass').value.trim();
            const grade = document.getElementById('new-grade').value;

            if (!id || !name) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
            const password = passInput || '123456';

            const { error } = await supabaseAdmin.auth.admin.createUser({
                email: id + DOMAIN_SUFFIX,
                password: password,
                email_confirm: true,
                user_metadata: { grade: grade, name: name }
            });

            if (error) alert(error.message);
            else {
                alert(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: ${password})`);
                fetchUsers();
                document.getElementById('new-id').value = '';
                document.getElementById('new-name').value = '';
                document.getElementById('new-pass').value = '';
            }
        }

        async function deleteUser(uid) {
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?')) {
                await supabaseAdmin.auth.admin.deleteUser(uid);
                fetchUsers();
            }
        }
    </script>
</body>
</html>